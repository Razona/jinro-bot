# 人狼ゲームGM支援システム プロトタイプ開発要件

## プロジェクト概要

**目的:** Discordと通話アプリ(ZOOM等)を併用して行う人狼ゲームのGM作業を効率化・自動化するシステムの開発。将来的にはスプレッドシートを使用しない形式への移行を目指す。

**初期ターゲット:** アルティメット人狼式の13人村ルールで最低限動作するプロトタイプを作成する。

**技術的方針:** GM処理のコア部分はライブラリとして独立させ、様々な利用形態に対応できるようにする。

## プロトタイプ版における主な機能と要件

### 1. ゲーム進行フロー

1.  **レギュレーション設定:**
    * 初期プロトタイプでは、以下の項目のみ設定可能とする。
        * 自分襲撃の可否
        * 襲撃なしの可否
        * 同票時の処理（決戦投票の有無、決戦回数、決まらなかった場合の処理：吊りなし、ランダム処刑、両方処刑、引き分け）
    * その他のレギュレーション項目は、将来的な拡張を見据えつつ、プロトタイプでは固定値または省略する。
2.  **Discord連携:**
    * ゲーム用のカテゴリと各種チャンネル（共通、役職別、投票）を自動作成する。
    * 参加者募集のメッセージにスタンプを押したユーザーをプレイヤーリストとして取得する。
    * 各プレイヤーを共通チャンネルに招待する。
3.  **配役処理:**
    * プレイヤーリストに基づき、役職を割り当てる。
    * 各プレイヤーを割り当てられた役職のチャンネルに招待する。
4.  **ゲームフェーズ進行:**
    * **初夜フェーズ:**
        * タイマー作動（現時点ではダミーで可）
        * 役職アクションの受付（リアクション等で確認）
    * **昼議論フェーズ:**
        * タイマー作動（現時点ではダミーで可）
    * **投票フェーズ:**
        * 投票者と投票先を記録する。
        * 最多得票者が複数の場合は決選投票フェーズに移行する。
            * 決選投票では投票先のみを記録する（投票者は記録しない）。
        * 投票結果（投票順、各プレイヤーの得票数、最多得票者）を投票チャンネルに通知する。
    * **処刑者決定:**
        * 投票結果に基づき処刑者を決定する。
    * **勝利条件判定:**
        * 処刑後、勝利条件を満たした陣営がいるか判定する。
    * **夜フェーズ:**
        * 霊媒師に結果を送信する。
        * 各役職のアクションを実行する。
        * 勝利条件を満した陣営がいるか判定する。
    * 上記「昼議論フェーズ」以降を、勝利条件が満たされるまで繰り返す。
5.  **結果表示フェーズ:**
    * 最終的なゲーム結果を表示する。

### 2. プロトタイプ版で簡略化する点

* **タイマー機能:** 現時点では実際のタイマー処理は行わず、フェーズ移行のトリガーは手動または固定時間とする。
* **追加役職・第三陣営:** アルティメット人狼式の基本役職（狼、狂人、村人、占い師、霊媒師、狩人、共有者）のみを対象とし、その他の役職や第三陣営は考慮しない。
* **レギュレーション設定項目:** 上記「1. レギュレーション設定」で記載した項目以外は、固定値とするか、設定項目自体を省略する。
    * 人数（13人固定）
    * 役職構成（ア式13人村固定）
    * 役欠けの有無（なし固定）
    * 連続ガードの可否（可または不可で固定）
    * 初日占い（なし固定、または固定のランダム結果）
    * 各役職の詳細設定（なし）
* **モード選択:** ZOOMモード、Discordモード、GMレスモードといったモード選択機能は実装しない。
* **テンプレート機能:** レギュレーションテンプレートの読み込み・編集機能は実装しない。
* **セッションID機能:** 複数セッションの管理機能は実装せず、単一のゲーム進行のみを想定する（0番セッション相当の処理のみ）。ゲーム開始時に常に状態をリセットする。

### 3. 将来的な拡張を見据える点

* **GM処理のライブラリ化:** 将来的に様々なルールや役職に対応できるよう、GM処理のロジックは汎用的に設計し、ライブラリとして切り出せるように意識する。
* **レギュレーション設定の拡張性:** プロトタイプでは省略する設定項目も、将来的には追加できるよう、データ構造や処理フローを考慮する。
* **各役職の詳細設定:** 将来的に各役職の細かい挙動を設定できるように、拡張の余地を残す。
    * 例：占い師のCOタイミング、狩人の連続ガード制限、**勝利判定時に特定の第三陣営を村人陣営としてカウントする/しない**、など。
    * これらはニッチな設定であり、基本的には使わないことが多い機能と想定するが、柔軟性を持たせるために考慮する。

### 4. 特に詳細なフローが必要な箇所

* **投票フェーズ:**
    1.  投票開始アナウンス
    2.  プレイヤーからの投票受付（誰が誰に投票したかを記録）
    3.  投票締め切り
    4.  得票数集計
    5.  最多得票者の特定
    6.  最多得票者が1名の場合 → 処刑者決定へ
    7.  最多得票者が複数名の場合 → 決選投票へ
        * 決選投票対象者をアナウンス
        * 決選投票の投票受付（誰に投票したかのみ記録）
        * 決選投票の得票数集計
        * 決選投票の最多得票者を特定
        * 設定された回数決選投票を行っても同票の場合、設定に基づき処理（吊りなし、ランダム処刑など）
    8.  投票結果をチャンネルに投稿（誰が誰に投票したか、各プレイヤーの得票数を明示）
* **夜フェーズ:**
    1.  夜時間開始アナウンス
    2.  各役職のアクション受付
        * 占い師: 占い対象を選択
        * 狩人: 護衛対象を選択
        * 人狼: 襲撃対象を選択
    3.  アクション実行と結果処理
        * 狩人の護衛成功判定
        * 人狼の襲撃結果判定
        * 占い師の占い結果判定
    4.  霊媒師への結果送信（前日の処刑者の役職）
    5.  夜時間終了アナウンス

## 補足

* 現行のシステム構成（菜南スプシ、R鯖、本部bot）の役割分担を参考にしつつ、スプレッドシートからの脱却を意識した設計とする。
* APIエンドポイントの設計も、このドキュメントを元に進める。